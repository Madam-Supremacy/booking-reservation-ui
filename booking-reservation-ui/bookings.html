<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings - Booking System</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book"></i> Booking Management</h1>
            <nav>
                <a href="index.html"><i class="fas fa-home"></i> Home</a>
                <a href="resources.html"><i class="fas fa-list"></i> Resources</a>
                <a href="bookings.html" class="active"><i class="fas fa-book"></i> Bookings</a>
                <a href="availability.html"><i class="fas fa-check-circle"></i> Availability</a>
            </nav>
        </header>

        <main>
            <div class="management-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> All Bookings</h2>
                    <button class="btn btn-primary" onclick="showAddBookingForm()">
                        <i class="fas fa-calendar-plus"></i> Create New Booking
                    </button>
                </div>

                <!-- Add Booking Form (Initially Hidden) -->
                <div id="addBookingForm" class="form-container" style="display: none;">
                    <h3><i class="fas fa-calendar-plus"></i> Create New Booking</h3>
                    <form id="bookingForm" onsubmit="createBooking(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="resourceId"><i class="fas fa-building"></i> Resource</label>
                                <select id="resourceId" required onchange="checkAvailability()">
                                    <option value="">Select Resource</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="userId"><i class="fas fa-user"></i> User ID</label>
                                <input type="text" id="userId" required placeholder="e.g., john.doe">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="startTime"><i class="fas fa-clock"></i> Start Time</label>
                                <input type="datetime-local" id="startTime" required onchange="checkAvailability()">
                            </div>
                            
                            <div class="form-group">
                                <label for="endTime"><i class="fas fa-clock"></i> End Time</label>
                                <input type="datetime-local" id="endTime" required onchange="checkAvailability()">
                            </div>
                        </div>
                        
                        <div id="availabilityStatus" class="availability-status" style="display: none;">
                            <!-- Availability status will be shown here -->
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calendar-check"></i> Create Booking
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddBookingForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Bookings Table -->
                <div class="table-container">
                    <table id="bookingsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Resource</th>
                                <th>User</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsBody">
                            <tr><td colspan="7">Loading bookings...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer>
            <p>Booking Reservation System &copy; 2026 | Booking Management</p>
        </footer>
    </div>

    <script>
        let bookings = [];
        let resources = [];
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadResources();
            await loadBookings();
        });
        
        async function loadResources() {
            try {
                const response = await fetch('/api/resources');
                resources = await response.json();
                populateResourceDropdown();
            } catch (error) {
                console.error('Error loading resources:', error);
            }
        }
        
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                bookings = await response.json();
                displayBookings();
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsBody').innerHTML = 
                    '<tr><td colspan="7">Error loading bookings. Please try again.</td></tr>';
            }
        }
        
        function populateResourceDropdown() {
            const dropdown = document.getElementById('resourceId');
            dropdown.innerHTML = '<option value="">Select Resource</option>' +
                resources.map(resource => 
                    `<option value="${resource.id}">${resource.name} (${resource.type})</option>`
                ).join('');
        }
        
        function displayBookings() {
            const tableBody = document.getElementById('bookingsBody');
            
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No bookings found. Create your first booking!</td></tr>';
                return;
            }
            
            // Sort by start time (newest first)
            bookings.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            tableBody.innerHTML = bookings.map(booking => {
                const resource = resources.find(r => r.id === booking.resourceId);
                const resourceName = resource ? resource.name : `Resource #${booking.resourceId}`;
                
                return `
                    <tr>
                        <td>${booking.id}</td>
                        <td>${resourceName}</td>
                        <td>${booking.userId}</td>
                        <td>${formatDateTime(booking.startTime)}</td>
                        <td>${formatDateTime(booking.endTime)}</td>
                        <td><span class="status-badge ${booking.status.toLowerCase()}">${booking.status}</span></td>
                        <td class="actions">
                            ${booking.status === 'CONFIRMED' ? `
                                <button class="btn btn-sm btn-cancel" onclick="cancelBooking(${booking.id})">
                                    <i class="fas fa-times-circle"></i> Cancel
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-delete" onclick="deleteBooking(${booking.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function showAddBookingForm() {
            document.getElementById('addBookingForm').style.display = 'block';
            document.getElementById('bookingForm').reset();
            document.getElementById('availabilityStatus').style.display = 'none';
            
            // Set default times (now and 1 hour from now)
            const now = new Date();
            const startTime = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour from now
            const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // 2 hours from now
            
            document.getElementById('startTime').value = formatDateForInput(startTime);
            document.getElementById('endTime').value = formatDateForInput(endTime);
        }
        
        function hideAddBookingForm() {
            document.getElementById('addBookingForm').style.display = 'none';
        }
        
        function formatDateForInput(date) {
            return date.toISOString().slice(0, 16);
        }
        
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            const date = new Date(dateTimeStr.replace(' ', 'T'));
            return date.toLocaleString();
        }
        
        async function checkAvailability() {
            const resourceId = document.getElementById('resourceId').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!resourceId || !startTime || !endTime) return;
            
            // Convert datetime-local format to API format
            const startTimeFormatted = startTime.replace('T', ' ');
            const endTimeFormatted = endTime.replace('T', ' ');
            
            try {
                const response = await fetch('/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resourceId: parseInt(resourceId),
                        startTime: startTimeFormatted,
                        endTime: endTimeFormatted
                    })
                });
                
                const result = await response.json();
                const availabilityStatus = document.getElementById('availabilityStatus');
                
                if (result.error) {
                    availabilityStatus.innerHTML = `<div class="availability-unavailable">
                        <i class="fas fa-exclamation-circle"></i> Error checking availability: ${result.error}
                    </div>`;
                } else if (result.availableResources && result.availableResources.length > 0) {
                    const resource = result.availableResources[0];
                    if (resource.isAvailable) {
                        availabilityStatus.innerHTML = `<div class="availability-available">
                            <i class="fas fa-check-circle"></i> This resource is available for the selected time slot!
                        </div>`;
                    } else {
                        availabilityStatus.innerHTML = `<div class="availability-unavailable">
                            <i class="fas fa-times-circle"></i> This resource is not available for the selected time slot.
                            ${resource.conflictCount > 0 ? `There are ${resource.conflictCount} conflicting booking(s).` : ''}
                        </div>`;
                    }
                }
                
                availabilityStatus.style.display = 'block';
            } catch (error) {
                console.error('Error checking availability:', error);
            }
        }
        
        async function createBooking(event) {
            event.preventDefault();
            
            const booking = {
                resourceId: parseInt(document.getElementById('resourceId').value),
                userId: document.getElementById('userId').value,
                startTime: document.getElementById('startTime').value.replace('T', ' '),
                endTime: document.getElementById('endTime').value.replace('T', ' ')
            };
            
            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(booking)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Booking created successfully! Booking ID: ' + result.id);
                    hideAddBookingForm();
                    loadBookings(); // Refresh the list
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                alert('Failed to create booking. Please try again.');
            }
        }
        
        async function cancelBooking(id) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId: id })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Booking cancelled successfully!');
                    loadBookings(); // Refresh the list
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('Failed to cancel booking. Please try again.');
            }
        }
        
        async function deleteBooking(id) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Booking deleted successfully!');
                    loadBookings(); // Refresh the list
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Failed to delete booking. Please try again.');
            }
        }
    </script>
</body>
</html>